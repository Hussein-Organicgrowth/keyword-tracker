<!DOCTYPE html>
<html>
<head>
  <title>søgeord for <%= company.companyName %></title>
  <!-- Include Bootstrap CSS -->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css">
  <!-- Include Font Awesome for icons -->
  <script src="https://use.fontawesome.com/releases/v5.15.4/js/all.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" rel="stylesheet" />
  <style>
    .keyword {
      cursor: pointer;
    }
    
    .keyword:hover {
      color: blue;
    }
    .large-modal {
  max-width: 80%; /* Adjust this value as needed */
}
    </style>
</head>
<body>
  
  <div class="container mt-5">
    <h1 class="text-center">Søgeord for <%= company.companyName %></h1>
    
    <div class="row mt-4">
      <div class="col-md-6">
        <div class="card text-white bg-primary mb-3">
          <div class="card-body">
            <h5 class="card-title">Average Position for All Keywords</h5>
            <p id="averagePosition" class="card-text display-4"></p>
          </div>
        </div>
      </div>
      <div class="col-md-6">
        <div class="card text-white bg-success mb-3">
          <div class="card-body">
            <h5 class="card-title">Best Average Position for a Category</h5>
            <p id="bestAveragePosition" class="card-text display-4"></p>
          </div>
        </div>
      </div>
    </div>

<!-- Button to open the modal -->
<button type="button" class="btn btn-primary mb-5" data-toggle="modal" data-target="#addKeywordModal">
    Add Keywords
  </button>

  <!-- Modal -->
  <div class="modal fade" id="addKeywordModal" tabindex="-1" role="dialog" aria-labelledby="addKeywordModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="addKeywordModalLabel">Tilføj Søgeord</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <!-- Form to add new keywords -->
          <form action="/add-keyword/<%= company.companyName %>" method="POST">
            <div class="form-group">
              <label for="keywords">Søgeord (En per linje):</label>
              <textarea id="keywords" name="keywords" class="form-control" required></textarea>
            </div>
            <div class="form-group">
              <label for="category">Vælg Kategori:</label>
              <input list="categories" id="category" name="category" class="form-control" required>
              <datalist id="categories">
                <% categories.forEach(function(category) { %>
                  <option value="<%= category %>">
                <% }); %>
              </datalist>
            </div>
            <div class="form-group">
              <label for="language">Vælg Sprog</label>
              <select id="language" name="language" class="form-control" required>
                <% languages.forEach(function(language) { %>
                  <option value="<%= language.code %>"><%= language.name %></option>
                <% }); %>
              </select>
            </div>
            <input type="submit" value="Add Keywords" class="btn btn-primary">
          </form>
        </div>
      </div>
    </div>
  </div>

  <% var categories = [...new Set(company.keywords.map(keywordObj => keywordObj.category.toLowerCase().trim()))]; %>
  <% categories.forEach(function(category, index) { %>
    <div class="card mt-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <div>
              <h3 class="mb-0">
                <button class="btn btn-link text-decoration-none text-reset" type="button" data-toggle="collapse" data-target="#collapse<%= index %>"
                    style="color: #007bff; font-size: 24px; font-weight: bold;">
                  <%= category.charAt(0).toUpperCase() + category.slice(1) %>
                </button>
              </h3>
              <p style="color: #007bff; font-size: 16px; font-weight: bold;">
                Antal af søgeord: <%= company.keywords.filter(keywordObj => keywordObj.category.toLowerCase().trim() === category).length %>
              </p>
            </div>
            <form action="/delete-category/<%= company.companyName %>/<%= category %>" method="POST">
                <button class="btn btn-danger" type="submit">
                  <i class="fas fa-trash-alt"></i>
                </button>
              </form>
      <div id="collapse<%= index %>" class="collapse">
        <div class="card-body">
          <table class="table table-striped">
            <thead>
              <tr>
                <th>Søgeord</th>
                <th>Sprog</th>
                <th>Sidst checket</th>
                <th>Placering</th>
                <th>opdater eller slet</th>
              </tr>
            </thead>
            <tbody>
                <% company.keywords.filter(keywordObj => keywordObj.category.toLowerCase().trim() === category).forEach(function(keywordObj) { %>
                  <tr>
                    <td class="keyword" data-keyword="<%= keywordObj.keyword %>" data-company="<%= company.companyName %>"><%= keywordObj.keyword %></td>
                    <td><%= keywordObj.language %></td>
                    <% if (keywordObj.placements && keywordObj.placements.length > 0) { %>
                      <td><%= keywordObj.placements[keywordObj.placements.length - 1].date.toDateString() %></td>
                      <td><%= keywordObj.placements[keywordObj.placements.length - 1].rank %></td>
                    <% } else { %>
                      <td>No placements yet</td>
                      <td>No placements yet</td>
                    <% } %>
                    <td>
                      <!-- Update button -->
                      <form action="/update-keyword/<%= company.companyName %>/<%= keywordObj.keyword %>" method="POST" style="display: inline;">
                        <button class="btn btn-primary" type="submit">
                          <i class="fas fa-sync"></i>
                        </button>
                      </form>
                      <!-- Delete button -->
                      <form action="/delete-keyword/<%= company.companyName %>/<%= keywordObj.keyword %>" method="POST" style="display: inline;">
                        <button class="btn btn-danger" type="submit">
                          <i class="fas fa-trash-alt"></i>
                        </button>
                      </form>
                    </td>
                  </tr>
                <% }); %>
              </tbody>
          </table>
        </div>
      </div>
    </div>
  <% }); %>
    
  </div>
  <div class="modal fade" id="placementsModal" tabindex="-1" role="dialog" aria-labelledby="placementsModalLabel" aria-hidden="true">
    <div class="modal-dialog large-modal" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="placementsModalLabel">Keyword Placements</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
        
        <canvas id="placementsChart" style="height: 100px;"></canvas>
          
          <table class="table table-striped" id="placementsTable">
            <thead>
              <tr>
                <th>Date</th>
                <th>Rank</th>
              </tr>
            </thead>
            <tbody>
              <!-- Placements will be inserted here -->
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
  
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Include Bootstrap JS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>

  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js"></script>
  <script>
    var company = <%- JSON.stringify(company) %>;
    var categories = <%- JSON.stringify(categories) %>;
  </script>
  <script>
    var chart;
    $(document).ready(function() {
      
  // Calculate the average position for all keywords
  var totalRank = 0;
  var totalKeywords = 0;
  company.keywords.forEach(function(keywordObj) {
    keywordObj.placements.forEach(function(placement) {
      totalRank += placement.rank;
      totalKeywords++;
    });
  });
  var averagePosition = totalRank / totalKeywords;
  $('#averagePosition').text(averagePosition.toFixed(2));

  // Calculate the best average position for a category
  var bestAveragePosition = Infinity;
  var bestCategory = '';
  categories.forEach(function(category) {
    var totalRank = 0;
    var totalKeywords = 0;
    company.keywords.filter(keywordObj => keywordObj.category.toLowerCase().trim() === category).forEach(function(keywordObj) {
      keywordObj.placements.forEach(function(placement) {
        totalRank += placement.rank;
        totalKeywords++;
      });
    });
    var averagePosition = totalRank / totalKeywords;
    if (averagePosition < bestAveragePosition) {
      bestAveragePosition = averagePosition;
      bestCategory = category;
    }
  });
  $('#bestAveragePosition').text(bestCategory + ': ' + bestAveragePosition.toFixed(2));
});
  </script>
  <script>
    Chart.register({
  id: 'backgroundColorPlugin',
  beforeDraw: function(chart) {
    var ctx = chart.ctx;
    ctx.save();
    ctx.globalCompositeOperation = 'destination-over';
    ctx.fillStyle = 'rgba(211, 211, 211, 0.3)'; // Light gray background
    ctx.fillRect(0, 0, chart.width, chart.height);
    ctx.restore();
  }
});
    $(document).ready(function() {
      $('.keyword').click(function() {
        var keyword = $(this).data('keyword');
        var companyName = $(this).data('company');
        $.ajax({
          url: '/get-placements/' + encodeURIComponent(companyName) + '/' + encodeURIComponent(keyword),
          method: 'GET',
          success: function(placements) {
  $('#placementsTable tbody').empty();

  // Create an empty array to store unique dates
  var uniqueDates = [];

  // Filter placements to remove duplicates
  var uniquePlacements = placements.filter(function(placement) {
    var date = new Date(placement.date).toLocaleDateString();
    if (uniqueDates.indexOf(date) === -1) {
      uniqueDates.push(date);
      return true;
    }
    return false;
  });

  uniquePlacements.sort(function(a, b) {
   return new Date(b.date) - new Date(a.date);
  });

  // Display unique placements
  uniquePlacements.forEach(function(placement) {
  var date = new Date(placement.date);
  var dateString = date.toLocaleDateString();
  var timeString = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }); // 24-hour format without seconds
  $('#placementsTable tbody').append('<tr><td>' + dateString + ' ' + timeString + '</td><td>' + placement.rank + '</td></tr>');
});

   // Create arrays of dates and ranks
   var dates = placements.map(function(placement) {
    return new Date(placement.date).toLocaleDateString();
  });
  var ranks = placements.map(function(placement) {
    return placement.rank;
  });

  if (chart) {
    chart.destroy();
  }

  // Create a chart
  chart = new Chart(document.getElementById('placementsChart'), {
  type: 'line',
  data: {
    labels: dates,
    datasets: [{
      label: 'Placering',
      data: ranks,
      fill: false,
      borderColor: '#673AB7', // Deep purple line
      backgroundColor: '#673AB7', // Deep purple points
      pointBorderColor: '#fff', // White point borders
      pointBackgroundColor: '#673AB7', // Deep purple points
      pointHoverBackgroundColor: '#fff', // White hover color
      pointHoverBorderColor: '#673AB7', // Deep purple hover border
      borderWidth: 2
    }]
  },
  options: {
    responsive: true,
    scales: {
      y: {
        reverse: true,
        beginAtZero: true,
        grid: {
          color: 'rgba(0, 0, 0, 0.1)',
        },
        ticks: {
          color: '#666',
        }
      },
      x: {
        grid: {
          color: 'rgba(0, 0, 0, 0.1)',
        },
        ticks: {
          color: '#666',
        }
      }
    },
    plugins: {
      legend: {
        display: false
      },
      tooltip: {
        intersect: false
      }
    },
    hover: {
      mode: 'nearest',
      intersect: true
    },
    elements: {
      line: {
        tension: 0.4
      }
    },
    backgroundColor: 'rgba(211, 211, 211, 0.3)' // Light gray background
  }
});

  $('#placementsModal').modal('show');
}
        });
      });
    });
  </script>
</body>
</html>